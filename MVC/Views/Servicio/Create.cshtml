@model MVC.Models.ServicioViewModel

<h2>Alta Servicio</h2>

@if (ViewBag.Error != null)
{
    <div class="alert alert-danger" role="alert">
        @ViewBag.Error
    </div>
}
@if (ViewData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        @ViewData["ErrorMessage"]
    </div>
}

@using (Html.BeginForm("Create", "Servicio", FormMethod.Post))
{
    <div class="form-group">
        <label asp-for="Fecha" class="control-label"></label>
        <input type="date" asp-for="Fecha" class="form-control" />
        <span asp-validation-for="Fecha" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="VehiculoId" class="control-label"></label>
        <select asp-for="VehiculoId" asp-items="@Model.Vehiculos.Select(v => new SelectListItem { Value = v.Id.ToString(), Text = v.Matricula })" class="form-control">
            <option value="">-- Seleccione un Vehículo --</option>
        </select>
        <span asp-validation-for="VehiculoId" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Km" class="control-label"></label>
        <input asp-for="Km" class="form-control" />
        <span asp-validation-for="Km" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Siniestro" class="control-label"></label>
        <input class="form-check-input" asp-for="Siniestro" />
        <span asp-validation-for="Siniestro" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="ProximoServicio" class="control-label"></label>
        <input type="date" asp-for="ProximoServicio" class="form-control" />
        <span asp-validation-for="ProximoServicio" class="text-danger"></span>
    </div>

    <!-- Zona de Mantenimientos Dinámicos -->
    <h4>Mantenimientos</h4>
    <div id="mantenimientos-container">
        <!-- Aquí se agregarán los mantenimientos dinámicamente -->
    </div>
    <button type="button" class="btn btn-primary" onclick="addMantenimiento()">Agregar Mantenimiento</button>

    <div class="form-group">
        <input type="submit" value="Guardar" class="btn btn-success" />
    </div>
}

@section Scripts {
    <script>
        let mantenimientoIndex = 0;
        let repuestoIndex = 0; // Este índice será global para llevar la cuenta de todos los repuestos

        function addMantenimiento() {
            const mantenimientosContainer = document.getElementById('mantenimientos-container');
            const mantenimientoHtml = `
                <div class="mantenimiento-item" id="mantenimiento-${mantenimientoIndex}">
                    <h5>Mantenimiento #${mantenimientoIndex + 1}</h5>
                    <div class="form-group d-flex">
                        <div class="flex-fill">
                            <label>Mantenimiento</label>
                            <select name="MantenimientosId[${mantenimientoIndex}]" class="form-control">
                                <option value="">-- Seleccione un Mantenimiento --</option>
                                @foreach (var mantenimiento in Model.Mantenimientos)
                                {
                                    <option value="@mantenimiento.Id">@mantenimiento.Tarea</option>
                                }
                            </select>
                        </div>

                        <div class="flex-fill">
                            <label>Fecha Inicio</label>
                            <input type="datetime-local" name="Inicio[${mantenimientoIndex}]" class="form-control" />
                        </div>

                        <div class="flex-fill">
                            <label>Fecha Fin</label>
                            <input type="datetime-local" name="Fin[${mantenimientoIndex}]" class="form-control" />
                        </div>

                        <div class="flex-fill">
                            <label>Etapa</label>
                            <select name="EtapaId[${mantenimientoIndex}]" class="form-control">
                                <option value="">-- Seleccione una Etapa --</option>
                                @foreach (var etapa in Model.Etapas)
                                {
                                    <option value="@etapa.Id">@etapa.EtapaNombre</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Observaciones</label>
                        <input type="text" name="Observaciones[${mantenimientoIndex}]" class="form-control" />
                    </div>
                </div>
                <!-- Zona de Repuestos para este Mantenimiento -->
                <div id="repuestos-container-${mantenimientoIndex}">
                    <h6>Repuestos</h6>
                    <!-- Aquí se agregarán los repuestos dinámicamente -->
                </div>
                <button type="button" class="btn btn-secondary" onclick="addRepuesto(${mantenimientoIndex})">Agregar Repuesto</button>
            `;

            mantenimientosContainer.insertAdjacentHTML('beforeend', mantenimientoHtml);
            mantenimientoIndex++;
        }

        function addRepuesto(mantenimientoIndex) {
            const repuestosContainer = document.getElementById(`repuestos-container-${mantenimientoIndex}`);
            const repuestoHtml = `
                <div class="repuesto-item">
                    <div class="form-group">
                        <label>Repuesto</label>
                        <select name="ListaRepuestosUtilizados[${repuestoIndex}].RepuestoId" class="form-control">
                            <option value="">-- Seleccione un Repuesto --</option>
                            @foreach (var repuesto in Model.Repuestos)
                            {
                                <option value="@repuesto.Id">@repuesto.Nombre</option>
                            }
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" name="ListaRepuestosUtilizados[${repuestoIndex}].Cantidad" class="form-control" />
                    </div>
                </div>
            `;
            repuestosContainer.insertAdjacentHTML('beforeend', repuestoHtml);
            repuestoIndex++; // Incrementamos repuestoIndex para cada nuevo repuesto
        }
    </script>
}
